ARG PHP_VERSION=8.2
ARG TZ=Europe/Moscow

# Первый этап: установка Composer и копирование файлов composer.json и composer.lock
FROM laravelsail/php82-composer:latest as composer
COPY ./composer.json /var/www/html/
COPY ./composer.lock /var/www/html/


# Второй этап: установка зависимостей с использованием Composer
FROM webnitros/php-laravel-worker-composer-mysql:latest

USER root

COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

COPY ./docker/endpoint.sh /usr/local/bin/endpoint.sh
RUN chmod +x /usr/local/bin/endpoint.sh

# Копирование конфигурационного файла supervisord
COPY ./docker/app/supervisor/supervisord.conf /etc/supervisord.conf

COPY ./docker/app/php.ini-production /usr/local/etc/php/conf.d/php.ini

WORKDIR /var/www/html

# копируем composer
COPY --from=composer /usr/bin/composer /usr/bin/composer
COPY --from=composer /var/www/html /var/www/html

# копируем файлы
COPY --chown=www-data:www-data . /var/www/html

USER www-data

# выполняем инсталяцию слоя в контенер
RUN composer install --no-dev

CMD ["endpoint.sh"]
